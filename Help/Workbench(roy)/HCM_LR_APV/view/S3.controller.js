/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ca.ui.dialog.factory");jQuery.sap.require("hcm.mgr.approve.leaverequests.util.Conversions");jQuery.sap.require("sap.ca.ui.message.message");sap.ca.scfld.md.controller.BaseDetailController.extend("hcm.mgr.approve.leaverequests.view.S3",{extHookChangeFooterButtons:null,onInit:function(){"use strict";this.resourceBundle=this.oApplicationFacade.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();this.oView=this.getView();this.mailSubject="";this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="detail"){var d=e.getParameter("arguments").contextPath;d=d.replace("LeaveRequestCollection","/LeaveRequestDetailsCollection");d=d.replace("')","',CalculateOverlaps=1)");this.oView.bindElement(d);if(this.oView.byId("LRAtc").getSelectedKey()!=="contentInfo"){this.oView.byId("LRAtc").setSelectedKey("contentInfo")}}},this)},getHeaderFooterOptions:function(){"use strict";var t=this;var o={sI18NDetailTitle:"view.Detail.title",oPositiveAction:{sI18nBtnTxt:t.resourceBundle.getText("XBUT_APPROVE"),onBtnPressed:jQuery.proxy(t._handleApprove,t)},oNegativeAction:{sI18nBtnTxt:t.resourceBundle.getText("XBUT_REJECT"),onBtnPressed:jQuery.proxy(t._handleReject,t)},oAddBookmarkSettings:{title:t.resourceBundle.getText("view.Detail.title"),icon:"sap-icon://card"},onBack:jQuery.proxy(function(){var d=sap.ui.core.routing.History.getInstance().getDirection(this.oRouter.getURL("master"));if(d==="Backwards"){window.history.go(-1)}else{this.oRouter.navTo("master")}},this)};var m=new sap.ui.core.routing.HashChanger();var u=m.getHash();if(u.indexOf("Shell-runStandaloneApp")>=0){o.bSuppressBookmarkButton=true}if(this.extHookChangeFooterButtons){o=this.extHookChangeFooterButtons(o)};return o},_handleTabSelect:function(e){"use strict";var k,c,d,s;k=e.getParameter("key");c=this.getView().getBindingContext();if(k==="contentNotes"){d="/LeaveRequestDetailsCollection(SAP__Origin='"+c.getProperty("SAP__Origin")+"',RequestId='"+c.getProperty("RequestId")+"',CalculateOverlaps=1)";s=function(D){this.oModel2=new sap.ui.model.json.JSONModel(D);this.getView().setModel(this.oModel2,"notes")};this.oDataModel.read(d,undefined,["$expand=Notes"],false,jQuery.proxy(s,this),jQuery.proxy(this.onRequestFailed,this))}},_handleApprove:function(){"use strict";var d=this.oView.getModel().getProperty(this.oView.getBindingContext().getPath()),a=true,c=function(R){this._handleApproveRejectExecute(R,a,d)},u=this.oView.getBindingContext().getProperty("RequesterName"),l=this.oView.getBindingContext().getProperty("LeaveTypeDesc"),A=this.oView.getBindingContext().getProperty("AbsenceDays"),s=this.oView.getBindingContext().getProperty("AbsenceHours"),b=this.oView.getBindingContext().getProperty("AllDayFlag"),L=this.oView.getBindingContext().getProperty("LeaveRequestType"),r=hcm.mgr.approve.leaverequests.util.Conversions.formatterAbsenceDurationAndUnit(A,s,b),e="";if(L==="3"){e=this.resourceBundle.getText("dialog.question.approvecancel",[u])}else{e=this.resourceBundle.getText("dialog.question.approve",[u])}sap.ca.ui.dialog.confirmation.open({question:e,showNote:true,additionalInformation:[{label:this.resourceBundle.getText("view.AddInfo.LeaveType"),text:l},{label:this.resourceBundle.getText("view.AddInfo.Requested"),text:r}],title:this.resourceBundle.getText("XTIT_APPROVAL"),confirmButtonLabel:this.resourceBundle.getText("XBUT_APPROVE")},jQuery.proxy(c,this))},_handleReject:function(){"use strict";var d=this.oView.getModel().getProperty(this.oView.getBindingContext().getPath()),a=false,c=function(o){this._handleApproveRejectExecute(o,a,d)},u=this.oView.getBindingContext().getProperty("RequesterName"),l=this.oView.getBindingContext().getProperty("LeaveTypeDesc"),A=this.oView.getBindingContext().getProperty("AbsenceDays"),s=this.oView.getBindingContext().getProperty("AbsenceHours"),b=this.oView.getBindingContext().getProperty("AllDayFlag"),L=this.oView.getBindingContext().getProperty("LeaveRequestType"),r=hcm.mgr.approve.leaverequests.util.Conversions.formatterAbsenceDurationAndUnit(A,s,b),R="";if(L==="3"){R=this.resourceBundle.getText("dialog.question.rejectcancel",[u])}else{R=this.resourceBundle.getText("dialog.question.reject",[u])}sap.ca.ui.dialog.confirmation.open({question:R,showNote:true,additionalInformation:[{label:this.resourceBundle.getText("view.AddInfo.LeaveType"),text:l},{label:this.resourceBundle.getText("view.AddInfo.Requested"),text:r}],title:this.resourceBundle.getText("XTIT_REJECT"),confirmButtonLabel:this.resourceBundle.getText("XBUT_REJECT")},jQuery.proxy(c,this))},_handleApproveRejectExecute:function(r,a,d){"use strict";if(r.isConfirmed){var e={},D,u;if(r.sNote){e.Comment=r.sNote}else{e.Comment=""}e.RequestId=d.RequestId;e.Version=d.Version;if(a){D="PREPARE_APPROVE";this.sTextKey="dialog.success.approve"}else{D="PREPARE_REJECT";this.sTextKey="dialog.success.reject"}e.Decision=D;e.SAP__Origin=d.SAP__Origin;u="ApplyLeaveRequestDecision?SAP__Origin='"+d.SAP__Origin+"'&RequestId='"+d.RequestId+"'&Version="+d.Version+"&Comment='"+r.sNote+"'&Decision='"+D+"'";this.oDataModel.setRefreshAfterChange(false);this.oDataModel.create(u,e,null,jQuery.proxy(this._handleApproveRejectSuccess,this),jQuery.proxy(this._handleApproveRejectFailure,this))}},_handleApproveRejectSuccess:function(){"use strict";var c=sap.ui.core.Component.getOwnerIdFor(this.oView),C=sap.ui.component(c);C.oEventBus.publish("hcm.mgr.approve.leaverequests","leaveRequestApproveReject");this.oDataModel.setRefreshAfterChange(true);this.oDataModel.refresh(true);sap.ca.ui.message.showMessageToast(this.resourceBundle.getText(this.sTextKey))},_handleApproveRejectFailure:function(e){"use strict";this.oDataModel.setRefreshAfterChange(true);if(this.oDataModel.hasPendingChanges()){this.oDataModel.refresh(true)}hcm.mgr.approve.leaverequests.util.Conversions.formatErrorDialog(e)},_handleOverlapTap:function(){"use strict";this.oRouter.navTo("calendar",{from:"detail",SAP__Origin:this.oView.getBindingContext().getProperty("SAP__Origin"),RequestId:this.oView.getBindingContext().getProperty("RequestId"),StartDate:Date.parse(this.oView.getBindingContext().getProperty("StartDate"))})},_handleNamePress:function(e){"use strict";jQuery.proxy(this._handleEmployeeNameClick(e),this)},_handleSenderPress:function(e){"use strict";jQuery.proxy(this._handleEmployeeNameClick(e),this)},_handleEmployeeNameClick:function(E){"use strict";this.oControl=E.getParameters().domRef;var c=this.oView.getBindingContext(),u=c.getProperty("RequesterNumber"),l=c.getProperty("LeaveTypeDesc"),s=c.getProperty("StartDate"),a=c.getProperty("StartTime"),b=c.getProperty("EndDate"),d=c.getProperty("EndTime"),f=c.getProperty("AllDayFlag"),t=hcm.mgr.approve.leaverequests.util.Conversions.formatterAbsenceDays3(s,a,b,d,f),S=this.resourceBundle.getText("view.BusinessCard.Employee.Subject",[l]);try{var i=E.getSource().getParent().getId();if(i.indexOf("NotesList")>=0){var g=E.getSource().getCounter();var m=this.getView().getModel("notes").getData();u=m.Notes.results[g].PersonNr}}catch(e){jQuery.sap.log.warning("Couldn't find the Details of employee","_handleEmployeeNameClick","hcm.mgr.approve.leaverequests.view.S3")}this.mailSubject=S+" "+t;this.oDataModel.read("EmployeeCollection",null,["$filter=EmployeeNumber eq '"+u+"'"],true,jQuery.proxy(this._onRequestSuccess,this),jQuery.proxy(this._onRequestFailed,this))},_onRequestSuccess:function(d){"use strict";jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");var a=d.results[0],e={title:"Employee",name:a.Name,department:a.Department,contactmobile:a.Mobile,contactphone:a.Phone,contactemail:a.Email,contactemailsubj:this.mailSubject,companyname:a.Company,companyaddress:a.Address},E=new sap.ca.ui.quickoverview.EmployeeLaunch(e);E.openBy(this.oControl)},_onRequestFailed:function(e){"use strict";sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:e.response.body})},isMainScreen:function(){return true}});
